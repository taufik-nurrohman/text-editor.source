/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e){return"function"==typeof e},s=function(e){return"number"==typeof e},c=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&f(r)&&e instanceof r}(e,Object))},f=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},l=function(e){return e.length},u=function e(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];for(var s=t.shift(),u=0,a=l(t);u<a;++u)for(var p in t[u])if(f(s[p]))if(i(s[p])&&i(t[u][p])){s[p]=[].concat(s[p]);for(var d=0,v=l(t[u][p]);d<v;++d)n(t[u][p][d],s[p])||s[p].push(t[u][p][d])}else c(s[p])&&c(t[u][p])?s[p]=e({},s[p],t[u][p]):s[p]=t[u][p];else s[p]=t[u][p];return s},a=window,p=function(e){return e&&e.preventDefault()},d=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},v=function(e){return t=RegExp,(r=e)&&d(t)&&r instanceof t;var r,t},h=function(e,r){return v(e)?e:RegExp(e,d(r)?r:"g")},w="Control-",$="Shift-",b=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function m(e){var r,t,i=this,o=i.k(!1).pop(),c=i.k();if(b(i),!e.defaultPrevented&&!i.keys[c]){var f,u,a=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",d=(null==(t=i.state.source)?void 0:t.pairs)||{},v=Object.values(d);(function(e){return s(e)&&0==e%1})(a)&&(a=" ".repeat(a));var m=i.$(),k=m.after,x=m.before,y=m.end,g=m.start,E=m.value,A=k.split("\n").shift(),B=x.split("\n").pop(),T=/^\s+/.exec(B),W=T&&T[0]||"";if(w+$+"Enter"===c)return x||k?(p(e),i.select(g-l(B)).wrap(W,"\n").insert(E).record(),!1):void 0;if(w+"Enter"===c&&(x||k))return p(e),i.select(y+l(A)).wrap("\n"+W,"").insert(E).record(),!1;if("Alt-"!=c+"-"&&w!==c+"-"){if(" "===c)return f=d[u=x.slice(-1)],!E&&f&&u&&f===k[0]?(p(e),i.wrap(" "," ")):void 0;if("Backspace"===c||"Delete"===c){if(f=d[u=x.slice(-1)],"\\"===u)return;return E?k&&x&&f&&f===k[0]&&!x.endsWith("\\"+u)?(p(e),i.record().peel(u,f).record()):void 0:(f=d[u=x.trim().slice(-1)])&&u&&(k.startsWith(" "+f)&&x.endsWith(u+" ")||k.startsWith("\n"+W+f)&&x.endsWith(u+"\n"+W))?(p(e),i.trim("","").record()):"Delete"!==c&&B.endsWith(a)?(p(e),i.pull(a).record()):k&&x&&!x.endsWith("\\"+u)&&f===k[0]&&u===x.slice(-1)?(p(e),i.peel(u,f).record()):void 0}if("Enter"!==c&&$+"Enter"!==c){if("\\"!==(u=x.slice(-1))){if(f=n(k[0],v)?k[0]:d[u],!E&&k&&x&&f&&o===f)return p(e),i.select(g+1).record();for(u in d){if(f=d[u],o===u&&f)return p(e),i.wrap(u,f).record();if(o===f){if(E)return p(e),i.record().wrap(u,f).record();break}}var j,D,S,O=[];if(E){for(j in d)(D=d[j])&&O.push("(?:\\"+j+"(?:\\\\.|[^\\"+j+(D!==j?"\\"+D:"")+"])*\\"+D+")");if(O.push("\\w+"),O.push("\\s+"),O.push("[\\s\\S]"),w+"ArrowLeft"===c)return p(e),(S=h("("+O.join("|")+")$","").exec(x))?i.insert("").select(g-l(S[0])).insert(E).record():i.select();if(w+"ArrowRight"===c)return p(e),(S=k.match(h("^("+O.join("|")+")","")))?i.insert("").select(y+l(S[0])-l(E)).insert(E).record():i.select()}if(y+=l(A),g-=l(B),E=B+E+A,w+"ArrowUp"===c){if(p(e),!n("\n",x))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var R=i.$();return x=R.before,g=R.start,B=x.split("\n").pop(),i.select(g-=l(B)).wrap(E,"\n"),i.select(g,g+l(E)),i.record()}if(w+"ArrowDown"===c){if(p(e),!n("\n",k))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var C=i.$();return k=C.after,y=C.end,A=k.split("\n").shift(),i.select(y+=l(A)).wrap("\n",E),y+=1,i.select(y,y+l(E)),i.record()}}}else if(!E){if(k&&x&&(f=d[u=x.slice(-1)])&&f===k[0])return p(e),i.wrap("\n"+W+(u!==f?a:""),"\n"+W).record();if(W)return p(e),i.insert("\n"+W,-1).record()}}else p(e)}}var k={attach:function(){var e=this;return e.state=u({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"}}},e.state),e.alert=function(r,t){return a.alert&&a.alert(r),o(t)&&t.call(e,!0)},e.confirm=function(r,t){return o(t)&&t.call(e,a.confirm&&a.confirm(r))},e.insertBlock=function(r,t){var n=e.$(),i=n.after,o=n.before,s=n.end,c=n.start,f=i.split("\n").shift(),u=l(f),a=o.split("\n").pop(),p=l(a),d=/^\s+/.exec(a),v=d&&d[0]||"";return-1===t?e.select(c-p).insert("\n",1).push(v).insert(r,1,!1):1===t?e.select(s+u).insert("\n",-1).push(v).insert(r,1,!1):e.select(c-p,s+u).insert(r,t,!0).wrap(v,"")},e.peelBlock=function(r,t,n){var i=e.$(),o=i.after,s=i.before,c=i.end,f=i.start,u=i.value,a=l(t),p=o.split("\n").shift(),d=l(p),v=s.split("\n").pop(),h=l(v),w=l(r);return n&&t===u.slice(-a)&&r===u.slice(0,w)||t===p.slice(-a)&&r===v.slice(0,w)?e.select(f-h+(n?0:w),c+d-(n?0:a)).peel(r,t,n):e.select(f,c)},e.prompt=function(r,t,n){return o(n)&&n.call(e,!!a.prompt&&a.prompt(r,t))},e.selectBlock=function(r){void 0===r&&(r=!0);var t=e.$(),n=t.after,i=t.before,o=t.end,s=t.start,c=t.value,f=n.split("\n").shift(),u=l(f),a=i.split("\n").pop(),p=l(a);if(!r){var d=/\s+$/.exec(f),v=/^\s+/.exec(a);d&&(u-=l(d[0])),v&&(p-=l(v[0]))}if(e.select(s-p,o+u),!r){var h,w=e.$();if(o=w.end,s=w.start,c=w.value,h=/^(\s+)?[\s\S]+?(\s+)?$/.exec(c))return e.select(s+l(h[1]||""),o-l(h[2]||""))}return e},e.toggle=function(r,t,n){var i=e.$(),o=i.after,s=i.before,c=i.value,f=l(t),u=l(r);return n&&t===c.slice(-f)&&r===c.slice(0,u)||t===o.slice(0,f)&&r===s.slice(-u)?e.peel(r,t,n):e.wrap(r,t,n)},e.toggleBlock=function(r,t,n){var i=e.$(),o=i.after,s=i.before,c=i.value,f=l(t),u=o.split("\n").shift(),a=s.split("\n").pop(),p=l(r);return n&&t===c.slice(-f)&&r===c.slice(0,p)||t===u.slice(-f)&&r===a.slice(0,p)?e.peelBlock(r,t,n):e.wrapBlock(r,t,n)},e.wrapBlock=function(r,t,n){var i=e.$(),o=i.after,s=i.before,c=i.end,f=i.start,u=o.split("\n").shift(),a=l(u),p=s.split("\n").pop(),d=l(p);return e.select(f-d,c+a).wrap(r,t,n)},e.on("key.down",m).record()},detach:function(){return this.off("key.down",m)}};return k}));