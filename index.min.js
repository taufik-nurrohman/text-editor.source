/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var t=function(e){return e.length},r=function(e,t){return-1!==t.indexOf(e)};const n={"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},i={source:{pairs:n}},s=Object.values(n);const c={};c.toggle=function(e,r,n){r||""===r||(r=e);let i=this,{after:s,before:c,value:o}=i.$(),a=t(r),l=t(e);return n&&r===o.slice(-a)&&e===o.slice(0,l)||r===s.slice(0,a)&&e===c.slice(-l)?i.peel(e,r,n):i.wrap(e,r,n)};let o=(a=e=>e.record(),l=100,function(){var e=arguments,t=this;f&&clearTimeout(f),f=setTimeout((function(){return a.apply(t,e)}),l)});var a,l,f;const u=i;e.canKeyDown=function(e,{a:t,c:r,s:c},o){let a,l,f=i.tab||o.state.tab||"\t",u=o.state.source?.pairs||n;if(t||r)return!0;if(" "===e&&!c){let{after:e,before:t,value:r}=o.$();return a=u[l=t.slice(-1)],!(!r&&a&&l&&a===e[0])||(o.wrap(" "," "),!1)}if("Enter"===e&&!c){let{after:e,before:t,value:r}=o.$(),n=t.split("\n").pop().match(/^(\s+)/),i=n&&n[1]||"";if(!r){if(e&&t&&(a=u[l=t.slice(-1)])&&a===e[0])return o.wrap("\n"+i+(l!==a?f:""),"\n"+i).record(),!1;if(i)return o.insert("\n"+i,-1).record(),!1}return!0}if("Backspace"===e&&!c){let{after:e,before:t,value:r}=o.$();e.split("\n")[0];let n=t.split("\n").pop(),i=n.match(/^(\s+)/),s=i&&i[1]||"";return a=u[l=t.slice(-1)],"\\"===l?!0:r?!(e&&t&&a&&a===e[0]&&!t.endsWith("\\"+l))||(o.record().peel(l,a).record(),!1):(a=u[l=t.trim().slice(-1)],a&&l&&(e.startsWith(" "+a)&&t.endsWith(l+" ")||e.startsWith("\n"+s+a)&&t.endsWith(l+"\n"+s))?(o.trim("","").record(),!1):n.endsWith(f)?(o.pull(f).record(),!1):!(e&&t&&!t.endsWith("\\"+l)&&a===e[0]&&l===t.slice(-1))||(o.peel(l,a).record(),!1))}let{after:p,before:d,start:h,value:b}=o.$();if("\\"===(l=d.slice(-1)))return!0;if(a=s.includes(p[0])?p[0]:u[l],!b&&p&&d&&a&&e===a)return o.select(h+1).record(),!1;for(l in u){if(a=u[l],l===e)return o.wrap(l,a).record(),!1;if(a===e){if(b)return o.record().wrap(l,a).record(),!1;break}}return!0},e.canKeyDownDent=function(e,{a:t,c:r,s:n},i){let s=i.state.tab||"\t";if(!t&&r){if("]"===e)return i.push(s).record(),!1;if("["===e)return i.pull(s).record(),!1}return!0},e.canKeyDownEnter=function(e,{a:r,c:n,s:i},s){if(n&&"Enter"===e){let{after:e,before:r,end:n,start:c,value:o}=s.$(),a=e.split("\n").shift(),l=r.split("\n").pop(),f=l.match(/^(\s+)/),u=f&&f[1]||"";if(r||e)return i?(s.select(c-t(l)).wrap(u,"\n").record(),!1):(s.select(n+t(a)).insert("\n"+u,-1).record(),!1)}return!0},e.canKeyDownHistory=function(e,{a:t,c:r,s:n},i){if(!t&&r){if("y"===e)return i.redo(),!1;if("z"===e)return i.undo(),!1}return!0},e.canKeyDownMove=function(e,{a:n,c:i,s:s},c){if(i){let{after:n,before:i,end:s,start:o,value:a}=c.$(),l=n.split("\n").shift(),f=i.split("\n").pop(),u=f.match(/^(\s+)/);if(u&&u[1],s+=t(l),o-=t(f),a=f+a+l,"ArrowUp"===e){if(!r("\n",i))return c.select(),!1;c.insert(""),c.replace(/^([^\n]*?)(\n|$)/,"$2",1),c.replace(/(^|\n)([^\n]*?)$/,"",-1);let e=c.$();return i=e.before,o=e.start,f=i.split("\n").pop(),c.select(o-=t(f)).wrap(a,"\n"),c.select(o,o+t(a)),c.record(),!1}if("ArrowDown"===e){if(!r("\n",n))return c.select(),!1;c.insert(""),c.replace(/^([^\n]*?)(\n|$)/,"",1),c.replace(/(^|\n)([^\n]*?)$/,"$1",-1);let e=c.$();return n=e.after,s=e.end,l=n.split("\n").shift(),c.select(s+=t(l)).wrap("\n",a),s+=1,c.select(s,s+t(a)),c.record(),!1}}return!0},e.canKeyDownTab=function(e,{a:t,c:r,s:n},i){let s=i.state.tab||"\t";return!("Tab"===e&&!t&&!r)||(i[n?"pull":"push"](s).record(),!1)},e.canKeyUp=function(e,{a:t,c:r,s:n},i){return o(i),!0},e.state=u,e.that=c}));