/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e){return"function"==typeof e},c=function(e){return"number"==typeof e},s=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&u(r)&&e instanceof r}(e,Object))},u=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},f=function(e){return e.length},l=function e(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];for(var c=t.shift(),l=0,a=f(t);l<a;++l)for(var p in t[l])if(u(c[p]))if(i(c[p])&&i(t[l][p])){c[p]=[].concat(c[p]);for(var d=0,h=f(t[l][p]);d<h;++d)n(t[l][p][d],c[p])||c[p].push(t[l][p][d])}else s(c[p])&&s(t[l][p])?c[p]=e({},c[p],t[l][p]):c[p]=t[l][p];else c[p]=t[l][p];return c},a=window,p=function(e){return e&&e.preventDefault()},d=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},h=function(e){return t=RegExp,(r=e)&&d(t)&&r instanceof t;var r,t},v=function(e,r){return h(e)?e:RegExp(e,d(r)?r:"g")},w="Control-",b="Shift-",m=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function y(e){var r,t,i=this,o=i.k(!1).pop(),s=i.k();if(m(i),!e.defaultPrevented&&!i.keys[s]){var u,l,a=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",d=(null==(t=i.state.source)?void 0:t.pairs)||{},h=Object.values(d);(function(e){return c(e)&&0==e%1})(a)&&(a=" ".repeat(a));var y=i.$(),$=y.after,g=y.before,k=y.end,x=y.start,E=y.value,A=$.split("\n").shift(),T=g.split("\n").pop(),W=/^\s+/.exec(T),j=W&&W[0]||"";if(w+b+"Enter"===s)return g||$?(p(e),i.select(x-f(T)).wrap(j,"\n").insert(E).record(),!1):void 0;if(w+"Enter"===s&&(g||$))return p(e),i.select(k+f(A)).wrap("\n"+j,"").insert(E).record(),!1;if("Alt-"!=s+"-"&&w!==s+"-"){if(" "===s)return u=d[l=g.slice(-1)],!E&&u&&l&&u===$[0]?(p(e),i.wrap(" "," ")):void 0;if("Backspace"===s||"Delete"===s){if(u=d[l=g.slice(-1)],"\\"===l)return;return E?$&&g&&u&&u===$[0]&&!g.endsWith("\\"+l)?(p(e),i.record().peel(l,u).record()):void 0:(u=d[l=g.trim().slice(-1)])&&l&&($.startsWith(" "+u)&&g.endsWith(l+" ")||$.startsWith("\n"+j+u)&&g.endsWith(l+"\n"+j))?(p(e),i.trim("","").record()):"Delete"!==s&&T.endsWith(a)?(p(e),i.pull(a).record()):$&&g&&!g.endsWith("\\"+l)&&u===$[0]&&l===g.slice(-1)?(p(e),i.peel(l,u).record()):void 0}if("Enter"!==s&&b+"Enter"!==s){if("\\"!==(l=g.slice(-1))){if(u=n($[0],h)?$[0]:d[l],!E&&$&&g&&u&&o===u)return p(e),i.select(x+1).record();for(l in d){if(u=d[l],o===l&&u)return p(e),i.wrap(l,u).record();if(o===u){if(E)return p(e),i.record().wrap(l,u).record();break}}var B,D,O,R=[];if(E){for(B in d)(D=d[B])&&R.push("(?:\\"+B+"(?:\\\\.|[^\\"+B+(D!==B?"\\"+D:"")+"])*\\"+D+")");if(R.push("\\w+"),R.push("\\s+"),R.push("[\\s\\S]"),w+"ArrowLeft"===s)return p(e),(O=v("("+R.join("|")+")$","").exec(g))?i.insert("").select(x-f(O[0])).insert(E).record():i.select();if(w+"ArrowRight"===s)return p(e),(O=$.match(v("^("+R.join("|")+")","")))?i.insert("").select(k+f(O[0])-f(E)).insert(E).record():i.select()}if(k+=f(A),x-=f(T),E=T+E+A,w+"ArrowUp"===s){if(p(e),!n("\n",g))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var S=i.$();return g=S.before,x=S.start,T=g.split("\n").pop(),i.select(x-=f(T)).wrap(E,"\n"),i.select(x,x+f(E)),i.record()}if(w+"ArrowDown"===s){if(p(e),!n("\n",$))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var C=i.$();return $=C.after,k=C.end,A=$.split("\n").shift(),i.select(k+=f(A)).wrap("\n",E),k+=1,i.select(k,k+f(E)),i.record()}}}else if(!E){if($&&g&&(u=d[l=g.slice(-1)])&&u===$[0])return p(e),i.wrap("\n"+j+(l!==u?a:""),"\n"+j).record();if(j)return p(e),i.insert("\n"+j,-1).record()}}else p(e)}}var $={attach:function(){var e=this;return e.state=l({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"}}},e.state),e.alert=function(r,t){return a.alert&&a.alert(r),o(t)&&t.call(e,!0)},e.confirm=function(r,t){return o(t)&&t.call(e,a.confirm&&a.confirm(r))},e.insertBlock=function(r,t){var n=e.$(),i=n.after,o=n.before,c=n.end,s=n.start,u=i.split("\n").shift(),l=f(u),a=o.split("\n").pop(),p=f(a),d=/^\s+/.exec(a),h=d&&d[0]||"";return-1===t?e.select(s-p).insert("\n",1).push(h).insert(r,1,!1):1===t?e.select(c+l).insert("\n",-1).push(h).insert(r,1,!1):e.select(s-p,c+l).insert(r,t,!0).wrap(h,"")},e.peelBlock=function(r,t,n){var i=e.$(),o=i.after,c=i.before,s=i.end,u=i.start;return e.select(u-f(c.split("\n").pop())+(n?0:f(r)),s+f(o.split("\n").shift())-(n?0:f(t||r))).peel(r,t,n)},e.prompt=function(r,t,n){return o(n)&&n.call(e,!!a.prompt&&a.prompt(r,t))},e.toggle=function(r,t,n){var i=e.$(),o=i.after,c=i.before,s=i.value,u=f(t),l=f(r);return n&&t===s.slice(-u)&&r===s.slice(0,l)||t===o.slice(0,u)&&r===c.slice(-l)?e.peel(r,t,n):e.wrap(r,t,n)},e.toggleBlock=function(e,r,t){},e.wrapBlock=function(r,t,n){var i=e.$(),o=i.after,c=i.before,s=i.end,u=i.start;return e.select(u-f(c.split("\n").pop()),s+f(o.split("\n").shift())).wrap(r,t,n)},e.on("key.down",y).record()},detach:function(){return this.off("key.down",y)}};return $}));