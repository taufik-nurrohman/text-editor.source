/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&c(r)&&e instanceof r}(e,Object))},c=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},s=function(e){return e.length},u=function e(){for(var r=arguments.length,t=Array(r),u=0;u<r;u++)t[u]=arguments[u];for(var f=t.shift(),a=0,l=s(t);a<l;++a)for(var d in t[a])if(c(f[d]))if(i(f[d])&&i(t[a][d])){f[d]=[].concat(f[d]);for(var p=0,v=s(t[a][d]);p<v;++p)n(t[a][d][p],f[d])||f[d].push(t[a][d][p])}else o(f[d])&&o(t[a][d])?f[d]=e({},f[d],t[a][d]):f[d]=t[a][d];else f[d]=t[a][d];return f},f=function(e){return e&&e.preventDefault()},a=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},l=function(e){return t=RegExp,(r=e)&&a(t)&&r instanceof t;var r,t},d=function(e,r){return l(e)?e:RegExp(e,a(r)?r:"g")},p="Control-",v="Shift-",h=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)}),w="TextEditor_"+Date.now();function y(e){var r,t,i=this[w],o=i.k(!1).pop(),c=i.k();if(i&&!e.defaultPrevented&&(h(i),!i.keys[c])){var u,a,l=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",y=(null==(t=i.state.source)?void 0:t.pairs)||{},b=Object.values(y),m=i.$(),E=m.after,g=m.before,$=m.end,x=m.start,A=m.value,T=E.split("\n").shift(),k=g.split("\n").pop(),W=k.match(/^(\s+)/),j=W&&W[1]||"";if(p+v+"Enter"===c)return g||E?(f(e),i.select(x-s(k)).wrap(j,"\n").insert(A).record(),!1):void 0;if(p+"Enter"===c&&(g||E))return f(e),i.select($+s(T)).wrap("\n"+j,"").insert(A).record(),!1;if("Alt-"!=c+"-"&&p!==c+"-"){if(" "===c)return u=y[a=g.slice(-1)],!A&&u&&a&&u===E[0]?(f(e),i.wrap(" "," ")):void 0;if("Backspace"===c){if(u=y[a=g.slice(-1)],"\\"===a)return;return A?E&&g&&u&&u===E[0]&&!g.endsWith("\\"+a)?(f(e),i.record().peel(a,u).record()):void 0:(u=y[a=g.trim().slice(-1)])&&a&&(E.startsWith(" "+u)&&g.endsWith(a+" ")||E.startsWith("\n"+j+u)&&g.endsWith(a+"\n"+j))?(f(e),i.trim("","").record()):k.endsWith(l)?(f(e),i.pull(l).record()):E&&g&&!g.endsWith("\\"+a)&&u===E[0]&&a===g.slice(-1)?(f(e),i.peel(a,u).record()):void 0}if("Enter"!==c&&v+"Enter"!==c){if("\\"!==(a=g.slice(-1))){if(u=n(E[0],b)?E[0]:y[a],!A&&E&&g&&u&&o===u)return f(e),i.select(x+1).record();for(a in y){if(u=y[a],o===a&&u)return f(e),i.wrap(a,u).record();if(o===u){if(A)return f(e),i.record().wrap(a,u).record();break}}var D,L,O,R=[];if(A){for(D in y)(L=y[D])&&R.push("(?:\\"+D+"(?:\\\\.|[^\\"+D+(L!==D?"\\"+L:"")+"])*\\"+L+")");if(R.push("\\w+"),R.push("\\s+"),R.push("[\\s\\S]"),p+"ArrowLeft"===c)return f(e),(O=g.match(d("("+R.join("|")+")$","")))?i.insert("").select(x-s(O[0])).insert(A).record():i.select();if(p+"ArrowRight"===c)return f(e),(O=E.match(d("^("+R.join("|")+")","")))?i.insert("").select($+s(O[0])-s(A)).insert(A).record():i.select()}if($+=s(T),x-=s(k),A=k+A+T,p+"ArrowUp"===c){if(f(e),!n("\n",g))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var S=i.$();return g=S.before,x=S.start,k=g.split("\n").pop(),i.select(x-=s(k)).wrap(A,"\n"),i.select(x,x+s(A)),i.record()}if(p+"ArrowDown"===c){if(f(e),!n("\n",E))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var B=i.$();return E=B.after,$=B.end,T=E.split("\n").shift(),i.select($+=s(T)).wrap("\n",A),$+=1,i.select($,$+s(A)),i.record()}}}else if(!A){if(E&&g&&(u=y[a=g.slice(-1)])&&u===E[0])return f(e),i.wrap("\n"+j+(a!==u?l:""),"\n"+j).record();if(j)return f(e),i.insert("\n"+j,-1).record()}}else f(e)}}var b={attach:function(e){var r=this;return r.state=u({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}},r.state),r.toggle=function(e,t,n,o){void 0===o&&(o=!1),t||""===t||(t=e);var u=r.$(),f=u.after,a=u.before,l=u.value,d=s(t),p=s(e);return n&&t===l.slice(-d)&&e===l.slice(0,p)||t===f.slice(0,d)&&e===a.slice(-p)?r.peel(e,t,n):(!1!==o&&("string"==typeof o?o=[o,o]:i(o)||(o=["",""]),c(o[1])||(o[1]=o[0]),r.trim(o[0],o[1])),r.wrap(e,t,n))},function(e,r,t,n){void 0===n&&(n=!1),r.addEventListener(e,t,n)}("keydown",e,y),e[w]=r,r.record()},detach:function(e){return delete e[w],function(e,r,t){r.removeEventListener(e,t)}("keydown",e,y),this}};return b}));