/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e){return"number"==typeof e},c=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&u(r)&&e instanceof r}(e,Object))},u=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},f=function(e){return e.length},s=function e(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];for(var s=t.shift(),l=0,a=f(t);l<a;++l)for(var p in t[l])if(u(s[p]))if(i(s[p])&&i(t[l][p])){s[p]=[].concat(s[p]);for(var d=0,h=f(t[l][p]);d<h;++d)n(t[l][p][d],s[p])||s[p].push(t[l][p][d])}else c(s[p])&&c(t[l][p])?s[p]=e({},s[p],t[l][p]):s[p]=t[l][p];else s[p]=t[l][p];return s},l=window,a=function(e){return e&&e.preventDefault()},p=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},d=function(e){return t=RegExp,(r=e)&&p(t)&&r instanceof t;var r,t},h=function(e,r){return d(e)?e:RegExp(e,p(r)?r:"g")},v="Control-",w="Shift-",m=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function y(e){var r,t,i=this,c=i.k(!1).pop(),u=i.k();if(i&&!e.defaultPrevented&&(m(i),!i.keys[u])){var s,l,p=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",d=(null==(t=i.state.source)?void 0:t.pairs)||{},y=Object.values(d);(function(e){return o(e)&&0==e%1})(p)&&(p=" ".repeat(p));var b=i.$(),$=b.after,g=b.before,E=b.end,x=b.start,A=b.value,k=$.split("\n").shift(),T=g.split("\n").pop(),W=T.match(/^(\s+)/),j=W&&W[1]||"";if(v+w+"Enter"===u)return g||$?(a(e),i.select(x-f(T)).wrap(j,"\n").insert(A).record(),!1):void 0;if(v+"Enter"===u&&(g||$))return a(e),i.select(E+f(k)).wrap("\n"+j,"").insert(A).record(),!1;if("Alt-"!=u+"-"&&v!==u+"-"){if(" "===u)return s=d[l=g.slice(-1)],!A&&s&&l&&s===$[0]?(a(e),i.wrap(" "," ")):void 0;if("Backspace"===u||"Delete"===u){if(s=d[l=g.slice(-1)],"\\"===l)return;return A?$&&g&&s&&s===$[0]&&!g.endsWith("\\"+l)?(a(e),i.record().peel(l,s).record()):void 0:(s=d[l=g.trim().slice(-1)])&&l&&($.startsWith(" "+s)&&g.endsWith(l+" ")||$.startsWith("\n"+j+s)&&g.endsWith(l+"\n"+j))?(a(e),i.trim("","").record()):"Delete"!==u&&T.endsWith(p)?(a(e),i.pull(p).record()):$&&g&&!g.endsWith("\\"+l)&&s===$[0]&&l===g.slice(-1)?(a(e),i.peel(l,s).record()):void 0}if("Enter"!==u&&w+"Enter"!==u){if("\\"!==(l=g.slice(-1))){if(s=n($[0],y)?$[0]:d[l],!A&&$&&g&&s&&c===s)return a(e),i.select(x+1).record();for(l in d){if(s=d[l],c===l&&s)return a(e),i.wrap(l,s).record();if(c===s){if(A)return a(e),i.record().wrap(l,s).record();break}}var D,O,R,S=[];if(A){for(D in d)(O=d[D])&&S.push("(?:\\"+D+"(?:\\\\.|[^\\"+D+(O!==D?"\\"+O:"")+"])*\\"+O+")");if(S.push("\\w+"),S.push("\\s+"),S.push("[\\s\\S]"),v+"ArrowLeft"===u)return a(e),(R=g.match(h("("+S.join("|")+")$","")))?i.insert("").select(x-f(R[0])).insert(A).record():i.select();if(v+"ArrowRight"===u)return a(e),(R=$.match(h("^("+S.join("|")+")","")))?i.insert("").select(E+f(R[0])-f(A)).insert(A).record():i.select()}if(E+=f(k),x-=f(T),A=T+A+k,v+"ArrowUp"===u){if(a(e),!n("\n",g))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var B=i.$();return g=B.before,x=B.start,T=g.split("\n").pop(),i.select(x-=f(T)).wrap(A,"\n"),i.select(x,x+f(A)),i.record()}if(v+"ArrowDown"===u){if(a(e),!n("\n",$))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var C=i.$();return $=C.after,E=C.end,k=$.split("\n").shift(),i.select(E+=f(k)).wrap("\n",A),E+=1,i.select(E,E+f(A)),i.record()}}}else if(!A){if($&&g&&(s=d[l=g.slice(-1)])&&s===$[0])return a(e),i.wrap("\n"+j+(l!==s?p:""),"\n"+j).record();if(j)return a(e),i.insert("\n"+j,-1).record()}}else a(e)}}var b={attach:function(){var e=this;return e.state=s({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}},e.state),e.alert=function(r,t){return l.alert&&l.alert(r),t.call(e,!0)},e.confirm=function(r,t){return t.call(e,l.confirm&&l.confirm(r))},e.prompt=function(r,t,n){return n.call(e,!!l.prompt&&l.prompt(r,t))},e.toggle=function(r,t,n){var i=e.$(),o=i.after,c=i.before,u=i.value,s=f(t),l=f(r);return n&&t===u.slice(-s)&&r===u.slice(0,l)||t===o.slice(0,s)&&r===c.slice(-l)?e.peel(r,t,n):e.wrap(r,t,n)},e.on("key.down",y).record()},detach:function(){return this.off("key.down",y)}};return b}));