/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var t=function(e){return e.length};const r={"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},n={source:{pairs:r}},i=Object.values(r);const c={};c.toggle=function(e,r,n){r||""===r||(r=e);let i=this,{after:c,before:o,value:s}=i.$(),a=t(r),u=t(e);return n&&r===s.slice(-a)&&e===s.slice(0,u)||r===c.slice(0,a)&&e===o.slice(-u)?i.peel(e,r,n):i.wrap(e,r,n)};let o=(s=e=>e.record(),a=100,function(){var e=arguments,t=this;u&&clearTimeout(u),u=setTimeout((function(){return s.apply(t,e)}),a)});var s,a,u;const f=n;e.canKeyDown=function(e,{a:t,c:c,s:o},s){let a,u,f=n.tab||s.state.tab||"\t",l=s.state.source?.pairs||r;if(t||c)return!0;if(" "===e&&!o){let{after:e,before:t,value:r}=s.$();return a=l[u=t.slice(-1)],!(!r&&a&&u&&a===e[0])||(s.wrap(" "," "),!1)}if("Enter"===e&&!o){let{after:e,before:t,value:r}=s.$(),n=t.split("\n").pop().match(/^(\s+)/),i=n&&n[1]||"";if(!r){if(e&&t&&(a=l[u=t.slice(-1)])&&a===e[0])return s.wrap("\n"+i+(u!==a?f:""),"\n"+i).record(),!1;if(i)return s.insert("\n"+i,-1).record(),!1}return!0}if("Backspace"===e&&!o){let{after:e,before:t,value:r}=s.$();e.split("\n")[0];let n=t.split("\n").pop(),i=n.match(/^(\s+)/),c=i&&i[1]||"";return a=l[u=t.slice(-1)],"\\"===u?!0:r?!(e&&t&&a&&a===e[0]&&!t.endsWith("\\"+u))||(s.record().peel(u,a).record(),!1):(a=l[u=t.trim().slice(-1)],a&&u&&(e.startsWith(" "+a)&&t.endsWith(u+" ")||e.startsWith("\n"+c+a)&&t.endsWith(u+"\n"+c))?(s.trim("","").record(),!1):n.endsWith(f)?(s.pull(f).record(),!1):!(e&&t&&!t.endsWith("\\"+u)&&a===e[0]&&u===t.slice(-1))||(s.peel(u,a).record(),!1))}let{after:p,before:d,start:h,value:b}=s.$();if("\\"===(u=d.slice(-1)))return!0;if(a=i.includes(p[0])?p[0]:l[u],!b&&p&&d&&a&&e===a)return s.select(h+1).record(),!1;for(u in l){if(a=l[u],u===e)return s.wrap(u,a).record(),!1;if(a===e){if(b)return s.record().wrap(u,a).record(),!1;break}}return!0},e.canKeyDownDent=function(e,{a:t,c:r,s:n},i){let c=i.state.tab||"\t";if(!t&&r){if("]"===e)return i.push(c).record(),!1;if("["===e)return i.pull(c).record(),!1}return!0},e.canKeyDownHistory=function(e,{a:t,c:r,s:n},i){if(!t&&r){if("y"===e)return i.redo(),!1;if("z"===e)return i.undo(),!1}return!0},e.canKeyDownTab=function(e,{a:t,c:r,s:n},i){let c=i.state.tab||"\t";return!("Tab"===e&&!t&&!r)||(i[n?"pull":"push"](c).record(),!1)},e.canKeyUp=function(e,{a:t,c:r,s:n},i){return o(i),!0},e.state=f,e.that=c}));