/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e){return"number"==typeof e},c=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&u(r)&&e instanceof r}(e,Object))},u=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},s=function(e){return e.length},f=function e(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];for(var f=t.shift(),l=0,a=s(t);l<a;++l)for(var d in t[l])if(u(f[d]))if(i(f[d])&&i(t[l][d])){f[d]=[].concat(f[d]);for(var p=0,h=s(t[l][d]);p<h;++p)n(t[l][d][p],f[d])||f[d].push(t[l][d][p])}else c(f[d])&&c(t[l][d])?f[d]=e({},f[d],t[l][d]):f[d]=t[l][d];else f[d]=t[l][d];return f},l=function(e){return e&&e.preventDefault()},a=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},d=function(e){return t=RegExp,(r=e)&&a(t)&&r instanceof t;var r,t},p=function(e,r){return d(e)?e:RegExp(e,a(r)?r:"g")},h="Control-",v="Shift-",w=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function y(e){var r,t,i=this,c=i.k(!1).pop(),u=i.k();if(i&&!e.defaultPrevented&&(w(i),!i.keys[u])){var f,a,d=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",y=(null==(t=i.state.source)?void 0:t.pairs)||{},b=Object.values(y);(function(e){return o(e)&&0==e%1})(d)&&(d=" ".repeat(d));var m=i.$(),g=m.after,$=m.before,E=m.end,x=m.start,A=m.value,k=g.split("\n").shift(),T=$.split("\n").pop(),W=T.match(/^(\s+)/),j=W&&W[1]||"";if(h+v+"Enter"===u)return $||g?(l(e),i.select(x-s(T)).wrap(j,"\n").insert(A).record(),!1):void 0;if(h+"Enter"===u&&($||g))return l(e),i.select(E+s(k)).wrap("\n"+j,"").insert(A).record(),!1;if("Alt-"!=u+"-"&&h!==u+"-"){if(" "===u)return f=y[a=$.slice(-1)],!A&&f&&a&&f===g[0]?(l(e),i.wrap(" "," ")):void 0;if("Backspace"===u||"Delete"===u){if(f=y[a=$.slice(-1)],"\\"===a)return;return A?g&&$&&f&&f===g[0]&&!$.endsWith("\\"+a)?(l(e),i.record().peel(a,f).record()):void 0:(f=y[a=$.trim().slice(-1)])&&a&&(g.startsWith(" "+f)&&$.endsWith(a+" ")||g.startsWith("\n"+j+f)&&$.endsWith(a+"\n"+j))?(l(e),i.trim("","").record()):"Delete"!==u&&T.endsWith(d)?(l(e),i.pull(d).record()):g&&$&&!$.endsWith("\\"+a)&&f===g[0]&&a===$.slice(-1)?(l(e),i.peel(a,f).record()):void 0}if("Enter"!==u&&v+"Enter"!==u){if("\\"!==(a=$.slice(-1))){if(f=n(g[0],b)?g[0]:y[a],!A&&g&&$&&f&&c===f)return l(e),i.select(x+1).record();for(a in y){if(f=y[a],c===a&&f)return l(e),i.wrap(a,f).record();if(c===f){if(A)return l(e),i.record().wrap(a,f).record();break}}var D,O,R,S=[];if(A){for(D in y)(O=y[D])&&S.push("(?:\\"+D+"(?:\\\\.|[^\\"+D+(O!==D?"\\"+O:"")+"])*\\"+O+")");if(S.push("\\w+"),S.push("\\s+"),S.push("[\\s\\S]"),h+"ArrowLeft"===u)return l(e),(R=$.match(p("("+S.join("|")+")$","")))?i.insert("").select(x-s(R[0])).insert(A).record():i.select();if(h+"ArrowRight"===u)return l(e),(R=g.match(p("^("+S.join("|")+")","")))?i.insert("").select(E+s(R[0])-s(A)).insert(A).record():i.select()}if(E+=s(k),x-=s(T),A=T+A+k,h+"ArrowUp"===u){if(l(e),!n("\n",$))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var B=i.$();return $=B.before,x=B.start,T=$.split("\n").pop(),i.select(x-=s(T)).wrap(A,"\n"),i.select(x,x+s(A)),i.record()}if(h+"ArrowDown"===u){if(l(e),!n("\n",g))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var C=i.$();return g=C.after,E=C.end,k=g.split("\n").shift(),i.select(E+=s(k)).wrap("\n",A),E+=1,i.select(E,E+s(A)),i.record()}}}else if(!A){if(g&&$&&(f=y[a=$.slice(-1)])&&f===g[0])return l(e),i.wrap("\n"+j+(a!==f?d:""),"\n"+j).record();if(j)return l(e),i.insert("\n"+j,-1).record()}}else l(e)}}return{attach:function(){var e=this;return e.state=f({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}},e.state),e.toggle=function(r,t,n,o){void 0===o&&(o=!1),t||""===t||(t=r);var c=e.$(),f=c.after,l=c.before,a=c.value,d=s(t),p=s(r);return n&&t===a.slice(-d)&&r===a.slice(0,p)||t===f.slice(0,d)&&r===l.slice(-p)?e.peel(r,t,n):(!1!==o&&("string"==typeof o?o=[o,o]:i(o)||(o=["",""]),u(o[1])||(o[1]=o[0]),e.trim(o[0],o[1])),e.wrap(r,t,n))},e.on("key.down",y).record()},detach:function(){return this.off("key.down",y)}}}));