/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e=function(e,r){return-1!==r.indexOf(e)},r=function(e){return Array.isArray(e)},t=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&n(r)&&e instanceof r}(e,Object))},n=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},i=function(e){return e.length},o=function o(){for(var u=arguments.length,c=Array(u),s=0;s<u;s++)c[s]=arguments[s];for(var f=c.shift(),l=0,a=i(c);l<a;++l)for(var d in c[l])if(n(f[d]))if(r(f[d])&&r(c[l][d])){f[d]=[].concat(f[d]);for(var p=0,h=i(c[l][d]);p<h;++p)e(c[l][d][p],f[d])||f[d].push(c[l][d][p])}else t(f[d])&&t(c[l][d])?f[d]=o({},f[d],c[l][d]):f[d]=c[l][d];else f[d]=c[l][d];return f},u=function(e,r,t){r.removeEventListener(e,t)},c=function(e){return e&&e.preventDefault()},s=function(e,r,t,n){void 0===n&&(n=!1),r.addEventListener(e,t,n)},f=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},l=function(e){return t=RegExp,(r=e)&&f(t)&&r instanceof t;var r,t},a=function(e,r){return l(e)?e:RegExp(e,f(r)?r:"g")},d="Control-",p="Shift-";function h(r){var t,n,o=this.TextEditor,u=this.Key;if(o&&u){var s,f,l=(null==(t=o.state.source)?void 0:t.tab)||o.state.tab||"\t",h=u+"",v=(null==(n=o.state.source)?void 0:n.pairs)||{},w=Object.values(v),y=o.$(),b=y.after,m=y.before,E=y.end,g=y.start,$=y.value,x=b.split("\n").shift(),A=m.split("\n").pop(),T=A.match(/^(\s+)/),W=T&&T[1]||"";if(d+"]"===h)return c(r),o.push(l).record();if(d+"["===h)return c(r),o.pull(l).record();if(d+"y"===h)return c(r),o.redo();if(d+"z"===h)return c(r),o.undo();if(d+p+"Enter"===h)return m||b?(c(r),o.select(g-i(A)).wrap(W,"\n").insert($).record(),!1):void 0;if(d+"Enter"===h&&(m||b))return c(r),o.select(E+i(x)).wrap("\n"+W,"").insert($).record(),!1;if("Alt-"!=h+"-"&&d!==h+"-"){if(" "===h)return s=v[f=m.slice(-1)],!$&&s&&f&&s===b[0]?(c(r),o.wrap(" "," ")):void 0;if("Backspace"===h){if(s=v[f=m.slice(-1)],"\\"===f)return;return $?b&&m&&s&&s===b[0]&&!m.endsWith("\\"+f)?(c(r),o.record().peel(f,s).record()):void 0:(s=v[f=m.trim().slice(-1)])&&f&&(b.startsWith(" "+s)&&m.endsWith(f+" ")||b.startsWith("\n"+W+s)&&m.endsWith(f+"\n"+W))?(c(r),o.trim("","").record()):A.endsWith(l)?(c(r),o.pull(l).record()):b&&m&&!m.endsWith("\\"+f)&&s===b[0]&&f===m.slice(-1)?(c(r),o.peel(f,s).record()):void 0}if("Enter"!==h&&p+"Enter"!==h){if("\\"!==(f=m.slice(-1))){if(s=e(b[0],w)?b[0]:v[f],h=h.replace(p,""),!$&&b&&m&&s&&h===s)return c(r),o.select(g+1).record();for(f in v){if(s=v[f],h===f&&s)return c(r),o.wrap(f,s).record();if(h===s){if($)return c(r),o.record().wrap(f,s).record();break}}var j,k,S,B=[];if($){for(j in v)(k=v[j])&&B.push("(?:\\"+j+"(?:\\\\.|[^\\"+j+(k!==j?"\\"+k:"")+"])*\\"+k+")");if(B.push("\\w+"),B.push("\\s+"),B.push("[\\s\\S]"),d+"ArrowLeft"===h)return c(r),(S=m.match(a("("+B.join("|")+")$","")))?o.insert("").select(g-i(S[0])).insert($).record():o.select();if(d+"ArrowRight"===h)return c(r),(S=b.match(a("^("+B.join("|")+")","")))?o.insert("").select(E+i(S[0])-i($)).insert($).record():o.select()}if(E+=i(x),g-=i(A),$=A+$+x,d+"ArrowUp"===h){if(c(r),!e("\n",m))return o.select();o.insert(""),o.replace(/^([^\n]*?)(\n|$)/,"$2",1),o.replace(/(^|\n)([^\n]*?)$/,"",-1);var L=o.$();return m=L.before,g=L.start,A=m.split("\n").pop(),o.select(g-=i(A)).wrap($,"\n"),o.select(g,g+i($)),o.record()}if(d+"ArrowDown"===h){if(c(r),!e("\n",b))return o.select();o.insert(""),o.replace(/^([^\n]*?)(\n|$)/,"",1),o.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var O=o.$();return b=O.after,E=O.end,x=b.split("\n").shift(),o.select(E+=i(x)).wrap("\n",$),E+=1,o.select(E,E+i($)),o.record()}}}else if(!$){if(b&&m&&(s=v[f=m.slice(-1)])&&s===b[0])return c(r),o.wrap("\n"+W+(f!==s?l:""),"\n"+W).record();if(W)return c(r),o.insert("\n"+W,-1).record()}}else c(r)}}function v(e){this.BounceSource()}var w={attach:function(e){var t,u,c,f=this;return f.state=o({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}},f.state),f.toggle=function(e,t,o,u){void 0===u&&(u=!1),t||""===t||(t=e);var c=f.$(),s=c.after,l=c.before,a=c.value,d=i(t),p=i(e);return o&&t===a.slice(-d)&&e===a.slice(0,p)||t===s.slice(0,d)&&e===l.slice(-p)?f.peel(e,t,o):(!1!==u&&("string"==typeof u?u=[u,u]:r(u)||(u=["",""]),n(u[1])||(u[1]=u[0]),f.trim(u[0],u[1])),f.wrap(e,t,o))},e.BounceSource=(t=function(){return f.record()},u=100,function(){var e=arguments,r=this;c&&clearTimeout(c),c=setTimeout((function(){return t.apply(r,e)}),u)}),s("keydown",e,h),s("keyup",e,v),f.record()},detach:function(e){return delete e.BounceSource,u("keydown",e,h),u("keyup",e,v),this}};return w}));