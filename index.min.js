/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):((e="undefined"!=typeof globalThis?globalThis:e||self).TextEditor=e.TextEditor||{},e.TextEditor.Source=r())}(this,(function(){"use strict";var e,r,t,n=function(e,r){return-1!==r.indexOf(e)},i=function(e){return Array.isArray(e)},o=function(e){return"function"==typeof e},c=function(e){return"number"==typeof e},u=function(e,r){return void 0===r&&(r=!0),"object"==typeof e&&(!r||function(e,r){return e&&f(r)&&e instanceof r}(e,Object))},f=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},s=function(e){return e.length},l=function e(){for(var r=arguments.length,t=Array(r),o=0;o<r;o++)t[o]=arguments[o];for(var c=t.shift(),l=0,a=s(t);l<a;++l)for(var p in t[l])if(f(c[p]))if(i(c[p])&&i(t[l][p])){c[p]=[].concat(c[p]);for(var d=0,v=s(t[l][p]);d<v;++d)n(t[l][p][d],c[p])||c[p].push(t[l][p][d])}else u(c[p])&&u(t[l][p])?c[p]=e({},c[p],t[l][p]):c[p]=t[l][p];else c[p]=t[l][p];return c},a=window,p=function(e){return e&&e.preventDefault()},d=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},v=function(e){return t=RegExp,(r=e)&&d(t)&&r instanceof t;var r,t},h=function(e,r){return v(e)?e:RegExp(e,d(r)?r:"g")},w="Control-",m="Shift-",y=(e=function(e){return e.record()},r=10,function(){var n=arguments,i=this;t&&clearTimeout(t),t=setTimeout((function(){return e.apply(i,n)}),r)});function b(e){var r,t,i=this,o=i.k(!1).pop(),u=i.k();if(y(i),!e.defaultPrevented&&!i.keys[u]){var f,l,a=(null==(r=i.state.source)?void 0:r.tab)||i.state.tab||"\t",d=(null==(t=i.state.source)?void 0:t.pairs)||{},v=Object.values(d);(function(e){return c(e)&&0==e%1})(a)&&(a=" ".repeat(a));var b=i.$(),$=b.after,g=b.before,x=b.end,E=b.start,A=b.value,k=$.split("\n").shift(),T=g.split("\n").pop(),W=/^(\s+)/.exec(T),j=W&&W[1]||"";if(w+m+"Enter"===u)return g||$?(p(e),i.select(E-s(T)).wrap(j,"\n").insert(A).record(),!1):void 0;if(w+"Enter"===u&&(g||$))return p(e),i.select(x+s(k)).wrap("\n"+j,"").insert(A).record(),!1;if("Alt-"!=u+"-"&&w!==u+"-"){if(" "===u)return f=d[l=g.slice(-1)],!A&&f&&l&&f===$[0]?(p(e),i.wrap(" "," ")):void 0;if("Backspace"===u||"Delete"===u){if(f=d[l=g.slice(-1)],"\\"===l)return;return A?$&&g&&f&&f===$[0]&&!g.endsWith("\\"+l)?(p(e),i.record().peel(l,f).record()):void 0:(f=d[l=g.trim().slice(-1)])&&l&&($.startsWith(" "+f)&&g.endsWith(l+" ")||$.startsWith("\n"+j+f)&&g.endsWith(l+"\n"+j))?(p(e),i.trim("","").record()):"Delete"!==u&&T.endsWith(a)?(p(e),i.pull(a).record()):$&&g&&!g.endsWith("\\"+l)&&f===$[0]&&l===g.slice(-1)?(p(e),i.peel(l,f).record()):void 0}if("Enter"!==u&&m+"Enter"!==u){if("\\"!==(l=g.slice(-1))){if(f=n($[0],v)?$[0]:d[l],!A&&$&&g&&f&&o===f)return p(e),i.select(E+1).record();for(l in d){if(f=d[l],o===l&&f)return p(e),i.wrap(l,f).record();if(o===f){if(A)return p(e),i.record().wrap(l,f).record();break}}var D,O,R,S=[];if(A){for(D in d)(O=d[D])&&S.push("(?:\\"+D+"(?:\\\\.|[^\\"+D+(O!==D?"\\"+O:"")+"])*\\"+O+")");if(S.push("\\w+"),S.push("\\s+"),S.push("[\\s\\S]"),w+"ArrowLeft"===u)return p(e),(R=h("("+S.join("|")+")$","").exec(g))?i.insert("").select(E-s(R[0])).insert(A).record():i.select();if(w+"ArrowRight"===u)return p(e),(R=$.match(h("^("+S.join("|")+")","")))?i.insert("").select(x+s(R[0])-s(A)).insert(A).record():i.select()}if(x+=s(k),E-=s(T),A=T+A+k,w+"ArrowUp"===u){if(p(e),!n("\n",g))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"$2",1),i.replace(/(^|\n)([^\n]*?)$/,"",-1);var B=i.$();return g=B.before,E=B.start,T=g.split("\n").pop(),i.select(E-=s(T)).wrap(A,"\n"),i.select(E,E+s(A)),i.record()}if(w+"ArrowDown"===u){if(p(e),!n("\n",$))return i.select();i.insert(""),i.replace(/^([^\n]*?)(\n|$)/,"",1),i.replace(/(^|\n)([^\n]*?)$/,"$1",-1);var C=i.$();return $=C.after,x=C.end,k=$.split("\n").shift(),i.select(x+=s(k)).wrap("\n",A),x+=1,i.select(x,x+s(A)),i.record()}}}else if(!A){if($&&g&&(f=d[l=g.slice(-1)])&&f===$[0])return p(e),i.wrap("\n"+j+(l!==f?a:""),"\n"+j).record();if(j)return p(e),i.insert("\n"+j,-1).record()}}else p(e)}}var $={attach:function(){var e=this;return e.state=l({source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"}}},e.state),e.alert=function(r,t){return a.alert&&a.alert(r),o(t)&&t.call(e,!0)},e.confirm=function(r,t){return o(t)&&t.call(e,a.confirm&&a.confirm(r))},e.prompt=function(r,t,n){return o(n)&&n.call(e,!!a.prompt&&a.prompt(r,t))},e.toggle=function(r,t,n){var i=e.$(),o=i.after,c=i.before,u=i.value,f=s(t),l=s(r);return n&&t===u.slice(-f)&&r===u.slice(0,l)||t===o.slice(0,f)&&r===c.slice(-l)?e.peel(r,t,n):e.wrap(r,t,n)},e.on("key.down",b).record()},detach:function(){return this.off("key.down",b)}};return $}));