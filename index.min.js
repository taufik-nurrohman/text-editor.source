/*!
 *
 * The MIT License (MIT)

 * Copyright © 2021 Taufik Nurrohman <https://github.com/taufik-nurrohman>

 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var r=function(e,r){return-1!==r.indexOf(e)},t=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},n=function(e){return e.length},i=window,s=function(e){return n=RegExp,(r=e)&&t(n)&&r instanceof n;var r,n},c=function(e,r){return s(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,t(r)?r:"g"))};const o={source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}};["alert","confirm","prompt"].forEach((e=>{o.source[e]=(...r)=>function(e,r){return new Promise(((t,n)=>{let s=i[e].apply(i,r);return s?t(s):n(s)}))}(e,r)}));const u={};u.toggle=function(e,r,t,i=!1){r||""===r||(r=e);let s=this,{after:c,before:o,value:u}=s.$(),a=n(r),f=n(e);return t&&r===u.slice(-a)&&e===u.slice(0,f)||r===c.slice(0,a)&&e===o.slice(-f)?s.peel(e,r,t):(!1!==i&&("string"==typeof i?i=[i,i]:function(e){return Array.isArray(e)}(i)||(i=["",""]),isSet(i[1])||(i[1]=i[0]),s.trim(i[0],i[1])),s.wrap(e,r,t))};let a=(f=e=>e.record(),l=100,function(){var e=arguments,r=this;p&&clearTimeout(p),p=setTimeout((function(){return f.apply(r,e)}),l)});var f,l,p;const d=o;e.canKeyDown=function(e,{a:r,c:t,s:n},i){let s,c,o=i.state.source.tab||i.state.tab||"\t",u=i.state.source.pairs||{},a=Object.values(u);if(r||t)return!0;if(" "===e&&!n){let{after:e,before:r,value:t}=i.$();return s=u[c=r.slice(-1)],!(!t&&s&&c&&s===e[0])||(i.wrap(" "," "),!1)}if("Enter"===e&&!n){let{after:e,before:r,value:t}=i.$(),n=r.split("\n").pop().match(/^(\s+)/),a=n&&n[1]||"";if(!t){if(e&&r&&(s=u[c=r.slice(-1)])&&s===e[0])return i.wrap("\n"+a+(c!==s?o:""),"\n"+a).record(),!1;if(a)return i.insert("\n"+a,-1).record(),!1}return!0}if("Backspace"===e&&!n){let{after:e,before:r,value:t}=i.$();e.split("\n")[0];let n=r.split("\n").pop(),a=n.match(/^(\s+)/),f=a&&a[1]||"";return s=u[c=r.slice(-1)],"\\"===c?!0:t?!(e&&r&&s&&s===e[0]&&!r.endsWith("\\"+c))||(i.record().peel(c,s).record(),!1):(s=u[c=r.trim().slice(-1)],s&&c&&(e.startsWith(" "+s)&&r.endsWith(c+" ")||e.startsWith("\n"+f+s)&&r.endsWith(c+"\n"+f))?(i.trim("","").record(),!1):n.endsWith(o)?(i.pull(o).record(),!1):!(e&&r&&!r.endsWith("\\"+c)&&s===e[0]&&c===r.slice(-1))||(i.peel(c,s).record(),!1))}let{after:f,before:l,start:p,value:d}=i.$();if("\\"===(c=l.slice(-1)))return!0;if(s=a.includes(f[0])?f[0]:u[c],!d&&f&&l&&s&&e===s)return i.select(p+1).record(),!1;for(c in u){if(s=u[c],c===e&&s)return i.wrap(c,s).record(),!1;if(s===e){if(d)return i.record().wrap(c,s).record(),!1;break}}return!0},e.canKeyDownDent=function(e,{a:r,c:t,s:n},i){let s=i.state.source.tab||i.state.tab||"\t";if(!r&&t){if("]"===e)return i.push(s).record(),!1;if("["===e)return i.pull(s).record(),!1}return!0},e.canKeyDownEnter=function(e,{a:r,c:t,s:i},s){if(t&&"Enter"===e){let{after:e,before:r,end:t,start:c,value:o}=s.$(),u=e.split("\n").shift(),a=r.split("\n").pop(),f=a.match(/^(\s+)/),l=f&&f[1]||"";if(r||e)return i?(s.select(c-n(a)).wrap(l,"\n").insert(o).record(),!1):(s.select(t+n(u)).wrap("\n"+l,"").insert(o).record(),!1)}return!0},e.canKeyDownHistory=function(e,{a:r,c:t,s:n},i){if(!r&&t){if("y"===e)return i.redo(),!1;if("z"===e)return i.undo(),!1}return!0},e.canKeyDownMove=function(e,{a:t,c:i,s:s},o){if(i){let i,s,u,{after:a,before:f,end:l,start:p,value:d}=o.$(),h=o.state.source.pairs||{},w=[];if(d){if(!t){for(i in h)(s=h[i])&&w.push("(?:\\"+i+"(?:\\\\.|[^\\"+i+(s!==i?"\\"+s:"")+"])*\\"+s+")");w.push("\\w+"),w.push("\\s+")}if(w.push("[\\s\\S]"),"ArrowLeft"===e)return(u=f.match(c("("+w.join("|")+")$","")))?(o.insert("").select(p-n(u[0])).insert(d),o.record(),!1):(o.select(),!1);if("ArrowRight"===e)return(u=a.match(c("^("+w.join("|")+")","")))?(o.insert("").select(l+n(u[0])-n(d)).insert(d),o.record(),!1):(o.select(),!1)}let b=a.split("\n").shift(),y=f.split("\n").pop(),m=y.match(/^(\s+)/);if(m&&m[1],l+=n(b),p-=n(y),d=y+d+b,"ArrowUp"===e){if(!r("\n",f))return o.select(),!1;o.insert(""),o.replace(/^([^\n]*?)(\n|$)/,"$2",1),o.replace(/(^|\n)([^\n]*?)$/,"",-1);let e=o.$();return f=e.before,p=e.start,y=f.split("\n").pop(),o.select(p-=n(y)).wrap(d,"\n"),o.select(p,p+n(d)),o.record(),!1}if("ArrowDown"===e){if(!r("\n",a))return o.select(),!1;o.insert(""),o.replace(/^([^\n]*?)(\n|$)/,"",1),o.replace(/(^|\n)([^\n]*?)$/,"$1",-1);let e=o.$();return a=e.after,l=e.end,b=a.split("\n").shift(),o.select(l+=n(b)).wrap("\n",d),l+=1,o.select(l,l+n(d)),o.record(),!1}}return!0},e.canKeyDownTab=function(e,{a:r,c:t,s:n},i){let s=i.state.source.tab||i.state.tab||"\t";return!("Tab"===e&&!r&&!t)||(i[n?"pull":"push"](s).record(),!1)},e.canKeyUp=function(e,{a:r,c:t,s:n},i){return a(i),!0},e.state=d,e.that=u}));