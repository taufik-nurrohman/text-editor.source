/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman
 *
 * <https://github.com/taufik-nurrohman/text-editor.source>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var r=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},t=function(e){return e&&e.preventDefault()},n=function(e){return n=RegExp,(t=e)&&r(n)&&t instanceof n;var t,n},i=function(e,t){return n(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,r(t)?t:"g"))};let o={"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},f=Object.keys(o);let u;e.onKeyDown=function(e,r){let n,u,c=r.state.tab||"\t",d=e.key,l=e.altKey,a=e.ctrlKey,s=e.shiftKey;if(l||a)return;if("Enter"===d&&!s){let{after:i,before:f,value:d}=r.$(),l=f.split("\n").pop().match(/^(\s+)/),a=l&&l[1]||"";if(!d){if(i&&f&&(n=o[u=f.slice(-1)])&&n===i[0])return r.wrap("\n"+a+(u!==n?c:""),"\n"+a).record(),void t(e);if(a)return r.insert("\n"+a,-1).record(),void t(e)}}if("Backspace"===d&&!s){let{after:i,before:f,value:d}=r.$();i.split("\n")[0];let l=f.split("\n").pop(),a=l.match(/^(\s+)/),s=a&&a[1]||"";if(n=o[u=f.slice(-1)],"\\"===u)return;if(d&&i&&f&&n&&n===i[0]&&!f.endsWith("\\"+u))return r.record().peel(u,n).record(),void t(e);if(n=o[u=f.trim().slice(-1)],n&&u&&i.startsWith("\n"+s+n)&&f.endsWith(u+"\n"+s))return r.trim("","").record(),void t(e);if(l.endsWith(c))return r.pull(c).record(),void t(e);if(i&&f&&!f.endsWith("\\"+u)&&n===i[0])return r.peel(u,n).record(),void t(e)}let{after:p,before:y,start:v,value:h}=r.$(),K=(m=f.join(""),void 0===T&&(T=""),m.replace(i("["+T+"\\^\\[\\]\\-]"),"\\$&")),b=y.match(i("(["+K+"])[^"+K+"]+$",""));var m,T;if(u=b&&b[1]||y.slice(-1),"\\"!==u){if(n=o[u],p&&y&&n&&d===n&&d===p[0])return h?(r.record().wrap(u,n).record(),void t(e)):(r.select(v+1).record(),void t(e));for(u in o){if(n=o[u],u===d)return r.wrap(u,n).record(),void t(e);if(n===d)return h?(r.record().wrap(u,n).record(),void t(e)):void 0}}},e.onKeyDownDent=function(e,r){let n=r.state.tab||"\t",i=e.key,o=e.altKey,f=e.ctrlKey;if(e.shiftKey,!o&&f){if("]"===i)return r.push(n).record(),void t(e);if("["===i)return r.pull(n).record(),void t(e)}},e.onKeyDownHistory=function(e,r){let n=e.key,i=e.altKey,o=e.ctrlKey;if(!i&&o){if("y"===n)return r.redo(),void t(e);if("z"===n)return r.undo(),void t(e)}},e.onKeyDownTab=function(e,r){let n=r.state.tab||"\t",i=e.key,o=e.altKey,f=e.ctrlKey,u=e.shiftKey;if("Tab"===i&&!o&&!f)return r[u?"pull":"push"](n).record(),void t(e)},e.onKeyUp=function(e,r){u&&clearTimeout(u),u=setTimeout((()=>r.record()),100)}}));