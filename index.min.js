/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman
 *
 * <https://github.com/taufik-nurrohman/text-editor.source>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var r=function(e){return e&&e.preventDefault()};let t={"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},n=Object.values(t);let i;e.onKeyDown=function(e,i){let o,f,u=i.state.tab||"\t",l=e.key,c=e.altKey,s=e.ctrlKey,d=e.shiftKey;if(c||s)return!0;if("Enter"===l&&!d){let{after:n,before:l,value:c}=i.$(),s=l.split("\n").pop().match(/^(\s+)/),d=s&&s[1]||"";if(!c){if(n&&l&&(o=t[f=l.slice(-1)])&&o===n[0])return i.wrap("\n"+d+(f!==o?u:""),"\n"+d).record(),r(e),!1;if(d)return i.insert("\n"+d,-1).record(),r(e),!1}}if("Backspace"===l&&!d){let{after:n,before:l,value:c}=i.$();n.split("\n")[0];let s=l.split("\n").pop(),d=s.match(/^(\s+)/),a=d&&d[1]||"";if(o=t[f=l.slice(-1)],"\\"===f)return!0;if(c)return!(n&&l&&o&&o===n[0]&&!l.endsWith("\\"+f))||(i.record().peel(f,o).record(),r(e),!1);if(o=t[f=l.trim().slice(-1)],o&&f&&n.startsWith("\n"+a+o)&&l.endsWith(f+"\n"+a))return i.trim("","").record(),r(e),!1;if(s.endsWith(u))return i.pull(u).record(),r(e),!1;if(n&&l&&!l.endsWith("\\"+f)&&o===n[0])return i.peel(f,o).record(),r(e),!1}let{after:a,before:p,start:y,value:K}=i.$();if("\\"===(f=p.slice(-1)))return!0;if(o=n.includes(a[0])?a[0]:t[f],!K&&a&&p&&o&&l===o)return i.select(y+1).record(),r(e),!1;for(f in t){if(o=t[f],f===l)return i.wrap(f,o).record(),r(e),!1;if(o===l){if(K)return i.record().wrap(f,o).record(),r(e),!1;break}}return!0},e.onKeyDownDent=function(e,t){let n=t.state.tab||"\t",i=e.key,o=e.altKey,f=e.ctrlKey;if(e.shiftKey,!o&&f){if("]"===i)return t.push(n).record(),void r(e);if("["===i)return t.pull(n).record(),void r(e)}return!0},e.onKeyDownHistory=function(e,t){let n=e.key,i=e.altKey,o=e.ctrlKey;if(!i&&o){if("y"===n)return t.redo(),void r(e);if("z"===n)return t.undo(),void r(e)}return!0},e.onKeyDownTab=function(e,t){let n=t.state.tab||"\t",i=e.key,o=e.altKey,f=e.ctrlKey,u=e.shiftKey;return!("Tab"===i&&!o&&!f)||(t[u?"pull":"push"](n).record(),void r(e))},e.onKeyUp=function(e,r){return i&&clearTimeout(i),i=setTimeout((()=>r.record()),100),!0}}));