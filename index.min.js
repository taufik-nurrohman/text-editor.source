/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2021 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.Source={}))}(this,(function(e){"use strict";var t=function(e,t){return-1!==t.indexOf(e)},r=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},n=function(e){return e.length},o=window,i=function(e){return n=RegExp,(t=e)&&r(n)&&t instanceof n;var t,n},s=function(e,t){return i(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,r(t)?t:"g"))};const c={source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}};["alert","confirm","prompt"].forEach((e=>{c.source[e]=(...t)=>function(e,t){return new Promise(((r,n)=>{let i=o[e].apply(o,t);return i?r(i):n(i)}))}(e,t)}));const l={};l.toggle=function(e,t,r,o=!1){t||""===t||(t=e);let i=this,{after:s,before:c,value:l}=i.$(),u=n(t),a=n(e);return r&&t===l.slice(-u)&&e===l.slice(0,a)||t===s.slice(0,u)&&e===c.slice(-a)?i.peel(e,t,r):(!1!==o&&("string"==typeof o?o=[o,o]:function(e){return Array.isArray(e)}(o)||(o=["",""]),isSet(o[1])||(o[1]=o[0]),i.trim(o[0],o[1])),i.wrap(e,t,r))};let u=(a=e=>e.record(),f=100,function(){var e=arguments,t=this;p&&clearTimeout(p),p=setTimeout((function(){return a.apply(t,e)}),f)});var a,f,p;const d=c;e.canKeyDown=function(e,r){let n,o,i=r.state.source.tab||r.state.tab||"\t",s=r.state.source.pairs||{},c=Object.values(s),{key:l,queue:u}=e,a=e+"";if(u.Alt||u.Control)return!0;if(" "===a){let{after:e,before:t,value:i}=r.$();return n=s[o=t.slice(-1)],!(!i&&n&&o&&n===e[0])||(r.wrap(" "," "),!1)}if("Enter"===a){let{after:e,before:t,value:c}=r.$(),l=t.split("\n").pop().match(/^(\s+)/),u=l&&l[1]||"";if(!c){if(e&&t&&(n=s[o=t.slice(-1)])&&n===e[0])return r.wrap("\n"+u+(o!==n?i:""),"\n"+u).record(),!1;if(u)return r.insert("\n"+u,-1).record(),!1}return!0}if("Backspace"===a){let{after:e,before:t,value:c}=r.$();e.split("\n")[0];let l=t.split("\n").pop(),u=l.match(/^(\s+)/),a=u&&u[1]||"";return n=s[o=t.slice(-1)],"\\"===o?!0:c?!(e&&t&&n&&n===e[0]&&!t.endsWith("\\"+o))||(r.record().peel(o,n).record(),!1):(n=s[o=t.trim().slice(-1)],n&&o&&(e.startsWith(" "+n)&&t.endsWith(o+" ")||e.startsWith("\n"+a+n)&&t.endsWith(o+"\n"+a))?(r.trim("","").record(),!1):l.endsWith(i)?(r.pull(i).record(),!1):!(e&&t&&!t.endsWith("\\"+o)&&n===e[0]&&o===t.slice(-1))||(r.peel(o,n).record(),!1))}let{after:f,before:p,start:d,value:h}=r.$();if("\\"===(o=p.slice(-1)))return!0;if(n=t(f[0],c)?f[0]:s[o],!h&&f&&p&&n&&l===n)return r.select(d+1).record(),!1;for(o in s){if(n=s[o],l===o&&n)return r.wrap(o,n).record(),!1;if(l===n){if(h)return r.record().wrap(o,n).record(),!1;break}}return!0},e.canKeyDownDent=function(e,t){let r=t.state.source.tab||t.state.tab||"\t",n=e+"";return"Control-]"===n?(t.push(r).record(),!1):"Control-["!==n||(t.pull(r).record(),!1)},e.canKeyDownEnter=function(e,t){let{key:r,queue:o}=e;if(o.Control&&o.Enter){let{after:e,before:r,end:i,start:s,value:c}=t.$(),l=e.split("\n").shift(),u=r.split("\n").pop(),a=u.match(/^(\s+)/),f=a&&a[1]||"";if(r||e)return o.Shift?(t.select(s-n(u)).wrap(f,"\n").insert(c).record(),!1):(t.select(i+n(l)).wrap("\n"+f,"").insert(c).record(),!1)}return!0},e.canKeyDownHistory=function(e,t){let r=e+"";return"Control-y"===r?(t.redo(),!1):"Control-z"!==r||(t.undo(),!1)},e.canKeyDownMove=function(e,r){let{key:o,queue:i}=e,c=e+"";if(!i.Control)return!0;let l,u,a,{after:f,before:p,end:d,start:h,value:w}=r.$(),b=r.state.source.pairs||{},y=[];if(w){for(l in b)(u=b[l])&&y.push("(?:\\"+l+"(?:\\\\.|[^\\"+l+(u!==l?"\\"+u:"")+"])*\\"+u+")");if(y.push("\\w+"),y.push("\\s+"),y.push("[\\s\\S]"),"Control-ArrowLeft"===c)return(a=p.match(s("("+y.join("|")+")$","")))?(r.insert("").select(h-n(a[0])).insert(w),r.record(),!1):(r.select(),!1);if("Control-ArrowRight"===c)return(a=f.match(s("^("+y.join("|")+")","")))?(r.insert("").select(d+n(a[0])-n(w)).insert(w),r.record(),!1):(r.select(),!1)}let m=f.split("\n").shift(),$=p.split("\n").pop(),v=$.match(/^(\s+)/);if(v&&v[1],d+=n(m),h-=n($),w=$+w+m,"Control-ArrowUp"===c){if(!t("\n",p))return r.select(),!1;r.insert(""),r.replace(/^([^\n]*?)(\n|$)/,"$2",1),r.replace(/(^|\n)([^\n]*?)$/,"",-1);let e=r.$();return p=e.before,h=e.start,$=p.split("\n").pop(),r.select(h-=n($)).wrap(w,"\n"),r.select(h,h+n(w)),r.record(),!1}if("Control-ArrowDown"===c){if(!t("\n",f))return r.select(),!1;r.insert(""),r.replace(/^([^\n]*?)(\n|$)/,"",1),r.replace(/(^|\n)([^\n]*?)$/,"$1",-1);let e=r.$();return f=e.after,d=e.end,m=f.split("\n").shift(),r.select(d+=n(m)).wrap("\n",w),d+=1,r.select(d,d+n(w)),r.record(),!1}return!0},e.canKeyDownTab=function(e,t){let r=t.state.source.tab||t.state.tab||"\t",n=e+"";return"Tab"===n?(t.push(r).record(),!1):"Shift-Tab"!==n||(t.pull(r).record(),!1)},e.canKeyUp=function(e,t){return u(t),!0},e.state=d,e.that=l}));